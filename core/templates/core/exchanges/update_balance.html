{% extends "core/base.html" %}
{% load math_filters %}

{% block title %}Update Exchange Balance · Transaction Hub{% endblock %}
{% block page_title %}Update Exchange Balance{% endblock %}
{% block page_subtitle %}{{ account.client.name }} - {{ account.exchange.name }}{% endblock %}

{% block content %}
<div class="card" style="max-width: 500px;">
    {% if messages %}
        {% for message in messages %}
            <div style="padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; {% if message.tags == 'success' %}background: #d1fae5; color: #065f46; border: 1px solid #10b981;{% elif message.tags == 'error' %}background: #fee2e2; color: #991b1b; border: 1px solid #dc2626;{% else %}background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6;{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <div style="background: #ecfeff; padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #06b6d4;">
        <div style="font-size: 14px; color: #0e7490; margin-bottom: 8px;"><strong>Current Account Status</strong></div>
        <div style="font-size: 13px; color: #0e7490;">
            Funding: {{ account.funding|currency_inr }}<br>
            Exchange Balance: {{ account.exchange_balance|currency_inr }}
        </div>
    </div>
    
    <form method="post" id="balance-form">
        {% csrf_token %}
        <div class="form-row">
            <label class="field-label">New Exchange Balance *</label>
            <input 
                type="text" 
                id="balance_display" 
                class="field-input" 
                placeholder="Enter new balance"
                autocomplete="off"
                required
            >
            <input 
                type="hidden" 
                name="new_balance" 
                id="balance_actual"
                value="{{ account.exchange_balance }}"
                required
            >
            <div style="font-size: 13px; color: var(--muted); margin-top: 4px;">
                <span style="color: #06b6d4;">ℹ️</span> Amount will be automatically formatted with commas. You can type numbers normally.<br>
                Enter the new balance after trade/fee/profit/loss. Current balance: {{ account.exchange_balance|floatformat:0 }}
            </div>
        </div>
        
        <div class="form-row">
            <label class="field-label">Transaction Type *</label>
            <select name="transaction_type" class="field-input" required>
                <option value="TRADE">Trade</option>
                <option value="ADJUSTMENT">Adjustment</option>
            </select>
            <div style="font-size: 13px; color: var(--muted); margin-top: 4px;">
                Select the type of transaction that caused this balance change.
            </div>
        </div>
        
        <div class="form-row">
            <label class="field-label">Notes (Optional)</label>
            <textarea name="notes" class="field-input" rows="3" placeholder="Add any notes about this balance update"></textarea>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 20px;">
            <button type="submit" class="btn btn-primary">Update Balance</button>
            <a href="{% url 'exchange_account_detail' account.pk %}" class="btn">Cancel</a>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        initAmountInput('balance_display', 'balance_actual');
        
        // Format initial value on page load
        const displayInput = document.getElementById('balance_display');
        const hiddenInput = document.getElementById('balance_actual');
        if (hiddenInput.value) {
            displayInput.value = formatIndianNumber(hiddenInput.value);
        }
        
        // Form validation
        document.getElementById('balance-form').addEventListener('submit', function(e) {
            const hiddenInput = document.getElementById('balance_actual');
            const displayInput = document.getElementById('balance_display');
            
            let raw = displayInput.value.replace(/,/g, "").replace(/\D/g, "");
            
            if (!raw || parseInt(raw) < 0) {
                e.preventDefault();
                alert('Please enter a valid balance (zero or greater).');
                displayInput.focus();
                return false;
            }
            
            hiddenInput.value = raw;
        });
    });
</script>
{% endblock %}


